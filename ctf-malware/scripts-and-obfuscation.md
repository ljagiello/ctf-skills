# Scripts and Obfuscation Analysis

## Table of Contents

- [Obfuscated Scripts (General)](#obfuscated-scripts-general)
- [JavaScript Deobfuscation](#javascript-deobfuscation)
- [PowerShell Analysis](#powershell-analysis)
- [Junk Code Detection](#junk-code-detection)
- [Hex-Encoded Payloads](#hex-encoded-payloads)
- [Debian Package Analysis](#debian-package-analysis)

---

## Obfuscated Scripts (General)

- Replace `eval`/`bash` with `echo` to print underlying code
- Extract base64/hex blobs and analyze with `file`
- Common deobfuscation chain: base64 decode -> gzip decode -> reverse -> base64 decode

## JavaScript Deobfuscation

```javascript
// Replace eval with console.log
eval = console.log;
// Then run the obfuscated code

// Common patterns
unescape()           // URL decoding
String.fromCharCode() // Char codes
atob()               // Base64
```

## PowerShell Analysis

```powershell
# Common obfuscation
-enc / -EncodedCommand  # Base64 encoded
IEX / Invoke-Expression # Eval equivalent
[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($encoded))
```

## Junk Code Detection

**Pattern:** Obfuscation adds meaningless instructions around real code

**Identification:**
- NOP sleds, push/pop pairs that cancel
- Arithmetic that results in zero/identity
- Dead writes (register written but never read before next write)
- Unconditional jumps to next instruction

**Filtering technique:**
```python
# Identify real calls by looking for patterns
# junk, junk, junk, CALL target, junk, junk
# Extract call targets, ignore surrounding noise

def extract_real_calls(disassembly):
    calls = []
    for instr in disassembly:
        if instr.mnemonic == 'call' and not is_junk_target(instr.operand):
            calls.append(instr)
    return calls
```

## Hex-Encoded Payloads

- Convert hex to bytes, try common transformations: subtract 1, XOR with key

## Debian Package Analysis

```bash
ar -x package.deb           # Unpack debian package
tar -xf control.tar.xz      # Check control files
# Look for postinst scripts that execute payloads
```
